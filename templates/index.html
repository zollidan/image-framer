<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>InstaRetro</title>
    <link
      href="{{ url_for('static', path='/css/index.css') }}"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <h1>InstaRetro üéûÔ∏è</h1>
      <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç–∏–ª—å–Ω—É—é —Ä–µ—Ç—Ä–æ-—Ä–∞–º–∫—É.</p>

      <div id="error-container"></div>

      <form id="upload-form">
        <label for="file" class="file-label">–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ...</label>
        <input type="file" name="file" id="file" required accept="image/*" />
        <span id="file-name">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
        <button type="submit" id="submit-button">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å</button>
      </form>

      <div class="loader" id="loader"></div>
      <div class="result" id="result-container"></div>
      <!-- <iframe
        allow="autoplay *; encrypted-media *; fullscreen *; clipboard-write"
        frameborder="0"
        height="450"
        style="
          width: 100%;
          max-width: 660px;
          overflow: hidden;
          border-radius: 10px;
        "
        sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation"
        src="https://embed.music.apple.com/ru/album/salad-days/799685692"
      ></iframe> -->
    </div>

    <script>
      const form = document.getElementById("upload-form");
      const inputFile = document.getElementById("file");
      const fileNameSpan = document.getElementById("file-name");
      const submitButton = document.getElementById("submit-button");
      const loader = document.getElementById("loader");
      const resultContainer = document.getElementById("result-container");
      const errorContainer = document.getElementById("error-container");

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
      inputFile.addEventListener("change", () => {
        if (inputFile.files.length > 0) {
          fileNameSpan.textContent = inputFile.files[0].name;
        } else {
          fileNameSpan.textContent = "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault(); // –û—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã

        if (inputFile.files.length === 0) {
          displayError("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.");
          return;
        }

        const formData = new FormData();
        formData.append("file", inputFile.files[0]);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        loader.style.display = "block";
        submitButton.disabled = true;
        submitButton.textContent = "–û–±—Ä–∞–±–æ—Ç–∫–∞...";
        resultContainer.innerHTML = "";
        errorContainer.innerHTML = "";

        try {
          const response = await fetch("/process-json/", {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –Ω–æ–≤—ã–π JSON-—ç–Ω–¥–ø–æ–∏–Ω—Ç
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          if (!response.ok) {
            // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É
            throw new Error(data.detail || "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞");
          }

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          resultContainer.innerHTML = `
                    <h2>–ì–æ—Ç–æ–≤–æ!</h2>
                    <img src="${data.url}" alt="–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                    <a href="${data.url}" download>–°–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</a>
                `;
        } catch (error) {
          displayError(error.message);
        } finally {
          // –ü—Ä—è—á–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
          loader.style.display = "none";
          submitButton.disabled = false;
          submitButton.textContent = "–û–±—Ä–∞–±–æ—Ç–∞—Ç—å";
        }
      });

      function displayError(message) {
        errorContainer.innerHTML = `<div class="error">${message}</div>`;
      }
    </script>
  </body>
</html>
